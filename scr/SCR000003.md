# Implement brake pedal logic

## SCR ID
SCR000003

## Objective
Introduce **brake pedal logic** that *decelerates* the engine while the engine is ON. This SCR:
- Adds a new input `brake_pedal_position` (degrees 0–45).
- Updates the `engine_speed` evolution rule by subtracting a deceleration proportional to brake angle.
- Keeps the existing outputs schema `time,engine_state,engine_speed`.

## Scope
- Extends the C application under `app/` built in SCR000001/2.
- CSV-based interface for inputs/outputs remains unchanged.
- No gear logic in this SCR (handled by later SCRs).

## Assumptions
- **SCR000001** ignition logic is present and sets `engine_state` (1=ON, 0=OFF).
- **SCR000002** accelerator logic is present: `delta_acc = acc_pedal_position * 2` rpm/iteration when ON.
- Time proceeds in discrete iterations (one row = one iteration).
- Speed is integer rpm; never negative; capped at `max_engine_speed`.
- When ignition is OFF, `engine_speed` is forced to 0 on that row.

## Inputs (from input CSV)
- `time` (integer; optional; if absent, application may auto-generate 0..N-1)
- `ignition_switch` (0 or 1)
- `acc_pedal_position` (degrees, integer, range **0–45**) — already used by SCR2
- `brake_pedal_position` (degrees, integer, range **0–45**) — **new**

## Outputs (to output CSV)
- `time` (integer)
- `engine_state` (0 or 1) — from SCR000001 logic
- `engine_speed` (rpm, integer, **0..max_engine_speed**)

## Calibrations
- `max_engine_speed = 2000` rpm  *(existing)*
- `brake_gain_rpm_per_deg = 4`  *(new; default 4 rpm/deg)*

> Calibration file location: `app/calibration/calibration.txt` > (Do not hardcode constants in code. Allow `ECU_CALIB_PATH` override.)

## Algorithm / Logic
Let `engine_state` be set by ignition (SCR1). Let prior speed be `engine_speed_prev`.

1. If `engine_state == 0`:
   - `engine_speed = 0`
   - *(ignition OFF forces immediate zero)*

2. Else (engine ON):
   - Acceleration (SCR2): `delta_acc = clamp(acc_pedal_position, 0, 45) * 2`
   - Braking (new): `delta_brk = clamp(brake_pedal_position, 0, 45) * brake_gain_rpm_per_deg` *(default 4)*
   - Update: `engine_speed_tmp = engine_speed_prev + delta_acc - delta_brk`
   - Saturate: `engine_speed = clamp(engine_speed_tmp, 0, max_engine_speed)`

### Pseudocode
```
engine_state = ignition_switch ? 1 : 0

if engine_state == 0:
    engine_speed = 0
else:
    acc   = clamp(acc_pedal_position,   0, 45)
    brake = clamp(brake_pedal_position, 0, 45)
    delta_acc = acc * 2
    delta_brk = brake * brake_gain_rpm_per_deg   # default 4
    engine_speed = clamp(engine_speed_prev + delta_acc - delta_brk, 0, max_engine_speed)
```

## I/O CSV Schemas
**Input (columns)**
```
time,ignition_switch,acc_pedal_position,brake_pedal_position
```
**Output (columns)**
```
time,engine_state,engine_speed
```

## Edge Cases
- **Brake dominates**: If `delta_brk > delta_acc`, speed decreases accordingly but never below 0.
- **Ignition toggled OFF**: Speed resets to 0 immediately on that row.
- **Out-of-range angles**: Values <0 treated as 0; >45 treated as 45.
- **Missing fields**: Should cause a non-zero return code with clear error message to `stderr` (unless explicitly optional).

## Acceptance Criteria
- With ignition ON and non-zero brake, speed reduces by `4 * brake_pedal_position` rpm per iteration (minus any concurrent acceleration), not going below 0.
- With ignition OFF, speed is always 0 regardless of pedals.
- With both pedals applied, net update equals `+2*acc - 4*brake`, clipped to `[0, max_engine_speed]`.
- Output header exactly: `time,engine_state,engine_speed`; rows aligned with input.
- All provided testcases for SCR3 pass golden comparisons.

## File & Repo Changes
- **Code**:
  - Read `brake_pedal_position` from input CSV.
  - Add calibration read for `brake_gain_rpm_per_deg` (default 4).
  - Update speed evolution to subtract brake delta each iteration when engine ON.
- **Calibration**:
  - Add `brake_gain_rpm_per_deg = 4` to `app/calibration/calibration.txt`.
- **Testcases**:
  - Add `testcases/SCR000003/case*/{caseN.csv,golden.csv}` covering:
    - ON with constant brake only (speed decreases to 0).
    - ON with both pedals where brake > acc (net decel).
    - ON with both pedals where acc > brake (net accel but slower than SCR2-only).
    - OFF throughout (speed 0).
    - Toggle OFF then ON (reset behavior).
- **Docs**:
  - This file at `scr/SCR000003.md`.

## Definition of Done
- PR links and closes the SCR issue (`Closes #<issue-id>`).
- CI green for build and tests on PR and `main`.
- Golden-file comparisons pass for all SCR3 testcases.
- Tag created: `SCR_000003_implemented` (or included in next Release tag).
