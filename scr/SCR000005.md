# Implement cruise control (target speed hold)

## SCR ID
SCR000005

## Objective
Add **cruise control** that nudges engine speed toward a target when enabled, while preserving
existing accelerator/brake and gear behaviors from SCR2–SCR4.

## Scope
- Builds on SCR000001–SCR000004.
- No new outputs; only **inputs** and **calibrations**.
- Cruise is *assistive*: it adds a bounded control step toward the target when engaged.
- Brake pedal or manual accelerator input suspends cruise for that row.

## Inputs (from input CSV)
- `time` (integer; optional; autogenerated 0..N-1 if absent)
- `ignition_switch` (0 or 1)
- `acc_pedal_position` (0–45 deg)
- `brake_pedal_position` (0–45 deg)
- `current_gear` (1–5)
- **`cruise_enable`** (0 or 1) — new
- **`cruise_target_speed`** (rpm, integer) — new

## Outputs (to output CSV)
- `time,engine_state,engine_speed` (unchanged)

## Calibrations (add to `app/calibration/calibration.txt`)
- `max_engine_speed = 2000` *(existing)*
- `brake_gain_rpm_per_deg = 4` *(existing)*
- `gear_acc_multiplier_g1..g5` *(existing)*
- **Cruise control:**
  - `cc_kp = 0.2`                # proportional gain (unitless)
  - `cc_max_step_per_iter = 30`  # |delta_cc| clamp in rpm/iter
  - `cc_activation_gear_min = 3` # min gear to allow cruise
  - `cc_target_min = 300`        # min allowed target rpm
  - `cc_target_max = 2000`       # max allowed target rpm (≤ max_engine_speed)

> Use `ECU_CALIB_PATH` to override calibration file path at runtime.

## Algorithm / Logic
Let `engine_speed_prev` be speed from previous row. First apply SCR1–SCR4 as baseline.

1. **Ignition OFF** → `engine_speed = 0`.
2. **Clamp inputs**: `acc=clamp(acc_pedal_position,0,45)`, `brk=clamp(brake_pedal_position,0,45)`, `g=clamp(current_gear,1,5)`.
3. **Baseline deltas (SCR2–SCR4)**:
   - `delta_acc = acc * (2 * gear_acc_multiplier_g)`
   - `delta_brk = brk * brake_gain_rpm_per_deg`
   - `engine_speed_tmp = engine_speed_prev + delta_acc - delta_brk`
4. **Cruise control step** (adds to baseline) if *all* true:
   - `cruise_enable == 1`
   - `brk == 0` *(brake suspends cruise)*
   - `acc == 0` *(driver accel overrides cruise)*
   - `g >= cc_activation_gear_min`
   - `target = clamp(cruise_target_speed, cc_target_min, min(cc_target_max, max_engine_speed))`
   - `error = target - engine_speed_prev`
   - `delta_cc = clamp(round(cc_kp * error), -cc_max_step_per_iter, cc_max_step_per_iter)`
   - `engine_speed_tmp += delta_cc`
5. **Saturate and round**:
   - `engine_speed = clamp(round(engine_speed_tmp), 0, max_engine_speed)`

### Notes
- Cruise acts like a gentle nudge toward the target and never fights the brake or driver’s throttle input.
- When conditions are not met, cruise contributes **0** for that row.
- If `cruise_enable` toggles from 0→1 mid-run, controller starts immediately (no hysteresis window in this SCR).

## I/O CSV Schemas
**Input**
```
time,ignition_switch,acc_pedal_position,brake_pedal_position,current_gear,cruise_enable,cruise_target_speed
```
**Output**
```
time,engine_state,engine_speed
```

## Edge Cases
- Target outside `[cc_target_min..max_engine_speed]` is clamped.
- If `cc_kp * error` exceeds `cc_max_step_per_iter`, it is clipped to the bound.
- Gear below `cc_activation_gear_min` suspends cruise.
- Any brake input suspends cruise for that row.
- Ignition OFF forces speed to 0 regardless of cruise.

## Acceptance Criteria
- With cruise enabled (no brake, no manual accel) and suitable gear, speed converges toward `cruise_target_speed` with bounded per-iteration steps.
- Applying brake or throttle suspends cruise (baseline behavior takes over).
- Output header remains `time,engine_state,engine_speed`; row alignment equals input.
- Testcases for engage, track, suspend, and resume pass golden comparison.

## File & Repo Changes
- **Code**:
  - Parse `cruise_enable`, `cruise_target_speed` columns.
  - Read calibrations: `cc_kp`, `cc_max_step_per_iter`, `cc_activation_gear_min`, `cc_target_min`, `cc_target_max`.
  - Extend speed update to add `delta_cc` under the conditions above.
- **Calibration**: append cruise keys to `app/calibration/calibration.txt`.
- **Tests**: add `testcases/SCR000005/case*/{caseN.csv,golden.csv}` covering:
  - engage & track to target (no pedals),
  - suspend with brake,
  - suspend with manual accel,
  - gear below activation threshold,
  - saturation at bounds.
- **Docs**: this file `scr/SCR000005.md`.

## Definition of Done
- PR links and closes the SCR issue (`Closes #<issue-id>`).
- CI green on PR and `main`.
- All SCR5 testcases pass golden comparison.
- Tag created: `SCR_000005_implemented` (or included in next Release tag).
