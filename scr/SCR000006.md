# Implement coastdown (friction drag when no pedals, cruise off)

## SCR ID
SCR000006

## Objective
Add **coastdown (friction drag)** that gradually reduces engine speed when:
- ignition is ON (`engine_state == 1`),
- both pedals are **not** pressed (`acc_pedal_position == 0` and `brake_pedal_position == 0`), and
- **cruise control is disabled** (`cruise_enable == 0`).

This preserves prior behavior under throttle, brake, or active cruise (SCR2–SCR5).

## Scope
- Builds on SCR000001–SCR000005.
- Output schema unchanged: `time,engine_state,engine_speed`.
- CSV inputs unchanged; uses existing `ignition_switch`, `acc_pedal_position`, `brake_pedal_position`, `current_gear`, and `cruise_enable`.

## Inputs (from input CSV)
No new input columns.

## Outputs (to output CSV)
Unchanged.

## Calibrations (append to `app/calibration/calibration.txt`)
- `drag_rpm_per_iter = 5`  # rpm subtracted per iteration during coastdown (default 5)

> Use `ECU_CALIB_PATH` to override calibration file path at runtime.

## Algorithm / Logic
Let `engine_speed_prev` be previous iteration speed. Compute baseline per SCR2–SCR4 and optional cruise (SCR5):
```
engine_speed_tmp = engine_speed_prev + delta_acc(gear,acc) - delta_brk(brake)
if cruise_enable == 1 and brake == 0 and acc == 0 and gear >= cc_activation_gear_min:
    engine_speed_tmp += clamp(round(cc_kp * (target - engine_speed_prev)), -cc_max_step_per_iter, cc_max_step_per_iter)
```
Then apply **coastdown**:
```
if engine_state == 1 and acc == 0 and brake == 0 and cruise_enable == 0:
    engine_speed_tmp -= drag_rpm_per_iter
```
Finally clamp/round:
```
engine_speed = clamp(round(engine_speed_tmp), 0, max_engine_speed)
```

### Notes
- Coastdown applies **only** when both pedals are at 0 **and** cruise is disabled.
- No effect when ignition is OFF (engine_speed already 0), when throttle/brake are used, or when cruise is active.
- This SCR intentionally keeps behavior of previous SCR testcases intact.

## Edge Cases
- If `engine_speed_prev < drag_rpm_per_iter`, coastdown drives speed to 0 (not negative).
- If cruise is toggled ON mid-run, coastdown stops immediately on the same row (since condition requires `cruise_enable == 0`).
- If throttle or brake become non-zero, coastdown does not apply that row.

## Acceptance Criteria
- With ignition ON, no pedals, cruise OFF: engine speed decays by `drag_rpm_per_iter` rpm per row down to 0.
- With throttle applied or brake applied: **no coastdown** on those rows.
- With cruise enabled and no pedals: **no coastdown**; cruise behavior (SCR5) prevails.
- Output header remains `time,engine_state,engine_speed` with rows aligned to input.

## Testcases (to be added under `testcases/SCR000006/`)
- **case1**: No pedals, cruise OFF — verify linear decay (e.g., start at 200 → 195 → 190 ... → 0).
- **case2**: Mixed — ramp up with throttle, then release to coast; verify decay begins only when both pedals return to 0.
- **case3**: Cruise ON with no pedals — verify **no** decay (coastdown disabled), speed follows cruise.
- **case4**: Brake taps during coast — verify no coastdown on brake rows (brake dominates), coastdown resumes when brake=0 and acc=0.

## File & Repo Changes
- **Code**:
  - Parse `drag_rpm_per_iter` from calibration.
  - Extend speed update function to subtract coastdown drag under the condition above.
- **Calibration**:
  - Add `drag_rpm_per_iter = 5` to `app/calibration/calibration.txt`.
- **Tests**:
  - Add `testcases/SCR000006/case*/{caseN.csv,golden.csv}` per scenarios above.
- **Docs**:
  - This file `scr/SCR000006.md`.

## Definition of Done
- PR links and closes the SCR issue (`Closes #<issue-id>`).
- CI green on PR and `main`.
- All SCR6 testcases pass golden comparison.
- Tag created: `SCR_000006_implemented` (or included in next Release tag).
