# Implement slew‑rate limiting on engine_speed (rise/fall per iteration)

## SCR ID
SCR000008

## Objective
Add **slew‑rate limiting** so that `engine_speed` cannot jump too quickly between
consecutive rows. This improves drivability and test stability by capping both
the **rise** and **fall** per iteration, after all prior logic (SCR2–SCR7) has
computed a provisional speed.

## Scope
- Builds on SCR000001–SCR000007.
- No new inputs and no new outputs.
- Applies a final post‑processing step each row to limit |Δspeed| relative to the **previous output speed**.

## Inputs (from input CSV)
Unchanged.

## Outputs (to output CSV)
Unchanged: `time,engine_state,engine_speed`.

## Calibrations (append to `app/calibration/calibration.txt`)
- `slew_max_rise_per_iter = 50`   # max allowed increase in rpm per row
- `slew_max_fall_per_iter = 80`   # max allowed decrease in rpm per row

> Use `ECU_CALIB_PATH` to override calibration path at runtime.

## Algorithm / Logic
Let `speed_prev_out` be the engine speed actually **emitted on the previous row**.
Let `speed_tmp` be the provisional speed after SCR2–SCR7 (accel, brake, gear, cruise, coastdown, idle).

1. If `engine_state == 0` → `engine_speed = 0` (rate limit ignored).
2. Else compute desired change:
   - `delta = speed_tmp - speed_prev_out`
3. Apply asymmetric limits:
   - If `delta >  slew_max_rise_per_iter` → `speed_next = speed_prev_out + slew_max_rise_per_iter`
   - Else if `delta < -slew_max_fall_per_iter` → `speed_next = speed_prev_out - slew_max_fall_per_iter`
   - Else → `speed_next = speed_prev_out + delta` (no limiting)
4. Clamp and round:
   - `engine_speed = clamp(round(speed_next), 0, max_engine_speed)`

### Ordering
This step runs **after** SCR7 idle control each row, using the last row’s **output**
as `speed_prev_out`. On the very first processed row, use `speed_prev_out = 0`.

## Edge Cases
- Large downward steps (e.g., brake) are limited in magnitude by `slew_max_fall_per_iter` unless ignition goes OFF (then forced 0).
- If `slew_max_*` are zero, speed will hold at the previous value (except ignition OFF).
- Negative calibrations shall be treated as zero.
- Works together with saturation at `[0, max_engine_speed]`.

## Acceptance Criteria
- With aggressive accelerator or cruise steps, the increase per row never exceeds `slew_max_rise_per_iter` rpm.
- With strong braking or coastdown, the decrease per row never exceeds `slew_max_fall_per_iter` rpm (unless ignition OFF).
- Output header and row alignment unchanged.
- Golden comparisons demonstrate capped slopes in rising and falling scenarios.

## I/O CSV Schemas
**Input**
```
time,ignition_switch,acc_pedal_position,brake_pedal_position,current_gear,cruise_enable,cruise_target_speed
```
**Output**
```
time,engine_state,engine_speed
```

## File & Repo Changes
- **Code**:
  - Parse `slew_max_rise_per_iter`, `slew_max_fall_per_iter` from calibration (defaults 50/80; negatives coerced to 0).
  - After computing `speed_tmp` via existing pipeline (SCR2–SCR7), apply the rate‑limit step vs. previous **emitted** speed.
- **Calibration**:
  - Append the two new keys to `app/calibration/calibration.txt`.
- **Tests**:
  - Add `testcases/SCR000008/case*/{caseN.csv,golden.csv}` covering:
    - large commanded increase limited by rise cap,
    - large commanded decrease limited by fall cap,
    - ignition OFF forces immediate 0 (bypasses limiter),
    - interaction with idle near 600 rpm where limiter still respected.

## Definition of Done
- PR links and closes the SCR issue (`Closes #<issue-id>`).
- CI green on PR and `main`.
- All SCR8 testcases pass golden comparison.
- Tag created: `SCR_000008_implemented` (or included in next Release).
