# Implement idle speed control (minimum speed hold when no pedals, cruise off)

## SCR ID
SCR000007

## Objective
Maintain a **minimum idle speed** when the engine is ON, both pedals are released, and cruise is OFF.
This prevents the engine speed from decaying to 0 under coastdown (SCR6).

## Scope
- Builds on SCR000001–SCR000006.
- No new outputs; only calibrations and reuse of existing inputs.
- Idle control is a gentle assist that nudges speed up toward an idle target.
- Order of operations (per row): SCR2–SCR4 baseline → SCR5 cruise (if active) → SCR6 coastdown → **SCR7 idle control**.

## Inputs (from input CSV)
No new input columns.

## Outputs (to output CSV)
Unchanged: `time,engine_state,engine_speed`.

## Calibrations (append to `app/calibration/calibration.txt`)
- `idle_target_speed = 600`          # rpm target for idle
- `idle_kp = 0.2`                    # proportional gain (unitless)
- `idle_max_step_per_iter = 15`      # clamp for |delta_idle| in rpm/iter
- `idle_activation_gear_max = 5`     # apply idle control for gears ≤ this (default all gears)

> Use `ECU_CALIB_PATH` to override calibration file path at runtime.

## Algorithm / Logic
Let `engine_speed_prev` be previous iteration speed. Compute baseline as in SCR2–SCR6 first:
```
engine_speed_tmp = baseline_scr2to4(prev) + cruise_if_active(prev) - coastdown_if_applicable(prev)
```
Then apply **idle control** if all are true:
- `engine_state == 1`
- `acc_pedal_position == 0`
- `brake_pedal_position == 0`
- `cruise_enable == 0`
- `current_gear <= idle_activation_gear_max`
- `engine_speed_prev < idle_target_speed`

Idle step:
```
error     = idle_target_speed - engine_speed_prev
delta_idle = clamp( round(idle_kp * error), -idle_max_step_per_iter, idle_max_step_per_iter )
# only allow a positive nudge toward idle
if delta_idle < 0: delta_idle = 0
engine_speed_tmp += delta_idle
```
Finally clamp and round:
```
engine_speed = clamp( round(engine_speed_tmp), 0, max_engine_speed )
```

### Notes
- Idle control **does not fight the driver**: any non-zero accelerator or brake input disables it.
- Idle runs only with cruise disabled; cruise (SCR5) remains the higher-level controller.
- When coastdown (SCR6) would drag speed below idle target, idle adds a small positive step to keep speed near the target.
- This SCR aims for simple proportional behavior; integral/derivative terms are out-of-scope.

## Edge Cases
- When `engine_speed_prev >= idle_target_speed`, idle adds **0** (no overshoot by design).
- If `idle_kp * error` is small, rounding may yield 0; increase `idle_kp` or `idle_max_step_per_iter` via calibration if needed.
- Ignition OFF forces speed 0; idle is inactive.
- Gears above `idle_activation_gear_max` disable idle (for future extensions; default allows all gears).

## I/O CSV Schemas
**Input (unchanged)**
```
time,ignition_switch,acc_pedal_position,brake_pedal_position,current_gear,cruise_enable,cruise_target_speed
```
**Output (unchanged)**
```
time,engine_state,engine_speed
```

## Acceptance Criteria
- With ignition ON, no pedals, cruise OFF: speed decays via coastdown until near `idle_target_speed`, then stabilizes with small positive steps.
- With any pedal input (acc or brake): idle control does not act.
- With cruise enabled: idle control does not act; cruise behavior prevails.
- Output header and row alignment unchanged.

## Testcases (to be added under `testcases/SCR000007/`)
- **case1**: Coastdown from 800 rpm to idle target 600 and hold (~within a few iterations).
- **case2**: Toggle accelerator briefly while near idle; idle suspends then resumes.
- **case3**: Cruise ON near idle; idle stays inactive.
- **case4**: Gear above activation threshold (if set <5) disables idle.

## File & Repo Changes
- **Code**:
  - Parse calibrations: `idle_target_speed`, `idle_kp`, `idle_max_step_per_iter`, `idle_activation_gear_max`.
  - Extend speed update to add `delta_idle` under the conditions above (after SCR6 step).
- **Calibration**:
  - Append the new idle keys to `app/calibration/calibration.txt`.
- **Tests**:
  - Add `testcases/SCR000007/case*/{caseN.csv,golden.csv}` to validate stabilize-at-idle behavior.
- **Docs**:
  - This file `scr/SCR000007.md`.

## Definition of Done
- PR links and closes the SCR issue (`Closes #<issue-id>`).
- CI green on PR and `main`.
- All SCR7 testcases pass golden comparison.
- Tag created: `SCR_000007_implemented` (or included in next Release).
