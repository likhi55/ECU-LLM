# Implement accelerator pedal logic

## SCR ID
SCR000002

## Objective
Introduce **accelerator pedal logic** that increases engine speed while the engine is ON. Adds a new output `engine_speed` and reuses existing `engine_state` from SCR000001.

## Scope
- Applies to the C application under `app/` and testcase system under `testcases/`.
- CSV-based interface for inputs/outputs.
- No braking/gear logic in this SCR (handled by later SCRs).

## Assumptions
- The ignition logic from **SCR000001** is present and sets `engine_state` (`1` when ON, `0` when OFF).
- Time proceeds in discrete iterations (one row = one iteration).
- Engine speed never goes below `0` rpm.
- All speeds are integer rpm.

## Inputs (from input CSV)
- `time` (integer; optional; if absent, application may auto-generate 0..N-1)
- `ignition_switch` (0 or 1)
- `acc_pedal_position` (degrees, integer, range **0–45**)

## Outputs (to output CSV)
- `time` (integer)
- `engine_state` (0 or 1) — from SCR000001 logic
- `engine_speed` (rpm, integer, **0..max_engine_speed**)

## Calibrations
- `max_engine_speed = 2000` rpm

> Calibration file location: `app/calibration/calibration.txt` > (Do not hardcode constants in code.)

## Algorithm / Logic
1. Compute/retain `engine_state` as per SCR000001 (ignition ON ⇒ 1; OFF ⇒ 0).
2. Initialize `engine_speed` to **0** at the start of a run (or after a full reset).
3. If `engine_state == 1` (engine ON), the engine accelerates each iteration by:
   - `delta = acc_pedal_position * 2` rpm/iteration
4. If `engine_state == 0`, hold `engine_speed` at **0** rpm.
5. Saturate after update:
   - `engine_speed = min(engine_speed, max_engine_speed)`
6. Engine speed shall never be negative.

### Pseudocode
```
engine_state = (ignition_switch ? 1 : 0)

if engine_state == 0:
    engine_speed = 0
else:
    delta = acc_pedal_position * 2          # acc_pedal_position in [0..45]
    engine_speed_next = engine_speed + delta
    engine_speed = min(engine_speed_next, max_engine_speed)
```

## I/O CSV Schemas
**Input (example)** — `testcases/SCR000002/case1/case1.csv`
```
time,ignition_switch,acc_pedal_position
0,1,5
1,1,5
2,1,5
...
```

**Output (golden & app output)**
```
time,engine_state,engine_speed
0,1,0
1,1,10
2,1,20
...
```

> For `acc_pedal_position = 5°`, delta = 10 rpm/iter. > For `acc_pedal_position = 45°`, delta = 90 rpm/iter, capped by `max_engine_speed`.

## Edge Cases
- Ignition toggles OFF ⇒ `engine_speed` resets to **0** on that row.
- Very high `acc_pedal_position` values (≥45) must not push `engine_speed` over `max_engine_speed` after saturation.
- Missing or malformed fields shall cause a non-zero return code; the app should print a clear error to `stderr` and exit.

## Acceptance Criteria
- With ignition ON and constant `acc_pedal_position`, `engine_speed` rises by `2 * acc_pedal_position` rpm per iteration up to 2000 rpm.
- With ignition OFF, `engine_speed` is always 0 rpm.
- Output CSV header exactly matches `time,engine_state,engine_speed` and aligns row-for-row with input.
- All provided testcases under `testcases/SCR000002` pass `tools/compare_csv.py` with zero mismatches.

## Testcases (to be added)
- **case1**: ignition ON, `acc_pedal_position = 5°`, 20 rows; verify linear ramp 0,10,20,...
- **case2**: ignition ON, `acc_pedal_position = 45°`, verify saturation at 2000 rpm.
- **case3**: ignition toggles OFF mid-run; verify immediate reset of speed to 0 and resume ramp when ON again.
- **case4**: ignition OFF throughout; speed remains 0.

## File & Repo Changes
- **Code**: Update `app/`:
  - Read `acc_pedal_position` from input CSV.
  - Maintain `engine_speed` state across iterations.
  - Apply calibration from `app/calibration/calibration.txt`.
  - Write outputs `time,engine_state,engine_speed`.
- **Calibration**: Ensure `max_engine_speed` is in `app/calibration/calibration.txt`.
- **Testcases**: Add `testcases/SCR000002/case*/{caseN.csv,golden.csv}`.
- **Docs**: This file at `scr/SCR000002.md`.
- **CI**: Existing workflows run build & tests on PR and main.

## Definition of Done
- PR links and closes the SCR issue (`Closes #<issue-id>`).
- All CI checks pass.
- Golden-file comparisons pass for all testcases.
- Tag created: `SCR_000002_implemented` (or included in next Release tag).
