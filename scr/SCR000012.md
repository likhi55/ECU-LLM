# SCR000012 — BTO Release Ramp (soft restore of accelerator)

## Objective
After Brake–Throttle Override (SCR000011) stops being active, **gradually restore**
accelerator authority over a calibrated number of rows to avoid a sudden torque
spike. This is a non‑latching, short‑term ramp that only runs after the BTO
condition clears.

## Scope & Interfaces
- Builds on SCR000001–SCR000011.
- **Inputs/outputs unchanged.**
- Implemented in the same stage as SCR11 (effective accelerator pre‑processing),
  before SCR2–SCR7 baseline calculations.

## Calibrations (append to `app/calibration/calibration.txt`)
- `bto_release_ramp_rows = 3`  	# rows to restore from scaled → raw (0 = instant)
- `bto_release_reset_on_ign_off = 1`  	# clear ramp state when ignition turns OFF

**Constraints**
- `bto_release_ramp_rows ≥ 0` (clamped)
- `bto_release_reset_on_ign_off ∈ {0,1}`

## Definitions
- **BTO active**: `brake_pedal_position ≥ bto_brake_deg` **AND**
  `acc_pedal_position ≥ bto_acc_min_deg` (same as SCR11).
- **raw_acc**: input accelerator after clamping to [0..45].
- **scaled_acc**: `round(raw_acc * bto_acc_scale)` from SCR11.
- **eff_acc**: effective accelerator used by the baseline pipeline.

## Algorithm (row loop)
1. Compute `engine_state` and clamp `raw_acc`, `brake` to [0..45].
2. Determine `bto_active` as in SCR11.
3. **If `bto_active`**:  
   - `eff_acc = scaled_acc` (from SCR11)  
   - `ramp_rows_left = bto_release_ramp_rows`
4. **Else if `ramp_rows_left > 0`**: (BTO just cleared or still restoring)  
   - Let `diff = raw_acc - prev_eff_acc`  
   - Let `step = sign(diff) * ceil(|diff| / ramp_rows_left)` (at least ±1 if `diff ≠ 0`)  
   - `eff_acc = prev_eff_acc + step` (clamped to [0..45])  
   - `ramp_rows_left--`
5. **Else**: `eff_acc = raw_acc` (no BTO and no pending ramp).
6. Pass `eff_acc` to SCR2–SCR7. SCR8 (slew), SCR9 (limp), SCR10 (rev limiter) remain unchanged.
7. **State resets**: if `engine_state == 0` and `bto_release_reset_on_ign_off == 1`, then
   set `ramp_rows_left = 0` and `prev_eff_acc = 0`.

## Ordering & Interactions
- **Limp plausibility (SCR9)** still uses **raw** pedals (unchanged).
- Slew (SCR8) still limits changes vs previous **output speed**; this ramp only
  shapes the **input** to the baseline pipeline.
- If `bto_release_ramp_rows = 0`, behavior is identical to SCR11 (instant restore).

## Acceptance Criteria
- With BTO active, `eff_acc` equals `scaled_acc` (SCR11 behavior).
- On the first row after BTO clears, `eff_acc` begins stepping toward `raw_acc` and
  reaches `raw_acc` after exactly `bto_release_ramp_rows` rows (or sooner if `diff=0`).
- IGN OFF with `bto_release_reset_on_ign_off = 1` cancels any remaining ramp.

## Example Tests
- **case1**: Hold brake+acc for 5 rows (`bto_acc_scale=0.0`), then release brake; expect
  3‑row ramp from 0→raw_acc before normal ramping resumes.
- **case2**: `bto_release_ramp_rows=0` → instant restore on release (matches SCR11).
- **case3**: Toggle brake on/off repeatedly; verify each clear starts a fresh ramp.
